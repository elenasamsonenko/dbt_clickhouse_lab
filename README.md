## Втрое практическое занятие курса DWH Analyst
# "DWH powered by Clickhouse and dbt"

### Цели:
•  Создание хранилища данных на основе ClickHouse с использованием DBT.   
•  Развёртывание инфраструктуры как кода с помощью Terraform на облачной платформе Yandex.Cloud.   
•  Мгновенная разработка с помощью Github Codespaces.   
•  Проверка заданий с использованием Github Actions.   

## Data Build Tool (DBT)
Data Build Tool (DBT) - это открытое программное обеспечение, предназначенное для автоматизации процесса разработки и управления данных в аналитических проектах. DBT представляет собой инструмент, который позволяет аналитикам и инженерам данных эффективно создавать, тестировать и поддерживать базы данных и пайплайны данных.
Основная идея DBT заключается в том, что он позволяет создавать SQL-скрипты, которые определяют трансформации данных, а также автоматически генерируют соответствующие запросы к базе данных для выполнения этих трансформаций. Это позволяет разработчикам фокусироваться на логике бизнес-трансформаций данных, не заботясь о деталях выполнения запросов в базе данных.

# 1.	Настройка среды разработчика
В VS Code cоздаем локальную копию репозитория   
```
git clone https://github.com/kzzzr/dbt_clickhouse_lab.git
```  
После этого поднимаем контейнер для разработки с помощью инструмента DevContainer. Это позволяет создать изолированную среду разработки, которая содержит все необходимые зависимости и инструменты для работы над проектом.   
```
# build dev container
devcontainer build .

# open dev container
devcontainer open .
```
После успешного запуска контейнера рекомендуется войти в его среду выполнения, что позволяет осуществить проверку корректности установки необходимых инструментов. 
```
dbt –version
terraform -v
yc --version
``` 

Однако, при проверке версии dbt возникла ошибка, связанная с несовместимостью версий. Для решения этой проблемы было необходимо обновить версию пакета protobuf до значения не менее 3.19.0

```
 pip install protobuf>=3.19.0
```
![изображение](https://github.com/elenasamsonenko/dbt_clickhouse_lab/assets/129121912/d189454e-9167-4633-82ff-b04633aaa7cc)

Далее копируем содержимое файла .env.template в новый файл с именем .env. Данный файл содержи т логин и пароль, который необходимо изменить на новый
```  
cp .env.template .env

```
# 2. Развертывание инфраструктуры в Yandex.Cloud с помощью Terraform.
Инициализация рабочего окружения для работы с облачной платформой Yandex.Cloud 
```
yc init
```  
Устанавливаем несколько переменных окружения. Эти переменные могут использоваться в дальнейшем для аутентификации и настройки доступа к ресурсам Yandex.Cloud в рамках выполнения команд и скриптов.
```  
export YC_TOKEN=$(yc iam create-token)
export YC_CLOUD_ID=$(yc config get cloud-id)
export YC_FOLDER_ID=$(yc config get folder-id)
export $(xargs <.env)
```
Проверяем переменные окружения
```  
env | grep clickhouse
```
Инициализация Terraform
```  
terraform init
terraform validate
terraform fmt
terraform plan
terraform apply
```
При инициализации Terraform возникает ошибка, связанная с недействительным хостом реестра провайдеров.    
Создаем файл конфигурации terraformrc в рабочей директории, используя команду cp terraformrc ~/.terraformrc.     
Этот файл будет содержать настройки для установки провайдеров Terraform.   
Terraform has been successfully initialized!   

В результате успешно создан ClickHouse кластер
Сохранение значений вывода Terraform в виде переменных среды
```
export CLICKHOUSE_HOST=$(terraform output -raw clickhouse_host_fqdn)
export DBT_HOST=${CLICKHOUSE_HOST}
export DBT_USER=${CLICKHOUSE_USER}
export DBT_PASSWORD=${TF_VAR_clickhouse_password}
```
# 3. Подключение подключение к Clickhouse с помощью Dbeaver
Настраиваем подключение к Clickhouse через Dbeaver.   
DBeaver - это универсальный инструмент для управления базами данных, который поддерживает множество СУБД.    
Перед подключение необходимо получить SSL-сертификат (https://cloud.yandex.ru/ru/docs/managed-clickhouse/operations/connect#linux_1) и указать путь к сертификату в настройках базового подключения     
![изображение](https://github.com/elenasamsonenko/dbt_clickhouse_lab/assets/129121912/03c2b990-2933-4a9d-8e55-fdb56a76934c)    
![изображение](https://github.com/elenasamsonenko/dbt_clickhouse_lab/assets/129121912/e2c58a5f-2f79-49ed-9188-5c0eccf8e1d1)

Делаем "отладочный" запуска проекта dbt   
```
dbt debug
```
![изображение](https://github.com/elenasamsonenko/dbt_clickhouse_lab/assets/129121912/f622dc2c-5c92-4888-a831-325b437e1bc6)

# 4. Развертывание Хранилище данных
1. Устанавливаем необходимые пакеты для корректной работы проекта dbt. Обращаемся к  файлу packages.yml, который содержит список пакетов и их версий,
```
dbt deps
```
2.	Загрузка данных из S3 в Clickhouse с помощью макросов dbt
```
dbt run-operation init_s3_sources
```
3.	Прописываем данные об источнике в файле  sources.yml
4.	Построение моделей стейджинга (предварительной подготовки данных) для загрузки в слой marts
```
dbt build -s tag:staging
```
5.	Создаем витрину данных
```
dbt build -s f_lineorder_flat
```
6.	Создание dbt модели с именем f_orders_stats. Для этого необходимо ны создать SQL файл с названием f_orders_stats.sql и поместить его в каталог models dbt проекта.   
![image](https://github.com/elenasamsonenko/dbt_clickhouse_lab/assets/129121912/7854818d-a240-4aab-8ca5-da7bed874502)

# Результаты
1.	Настройка среды разработки: Установлены и настроены необходимые инструменты для работы с проектом, такие как dbt, GitHub и Terraform.
2.	Настройка подключения к Clickhouse через DBeaver: Получен SSL-сертификат и настроены параметры подключения к Clickhouse через DBeaver.
3.	Настройка переменных окружения для Terraform: Экспортированы значения вывода Terraform как переменные окружения для дальнейшего использования.
4.	Создание модели dbt для статистики заказов: Создана модель f_orders_stats, предназначенная для анализа статистики заказов, включающая в себя информацию о количестве заказов, клиентов и общей выручке.
5.	Создание Pull Request и прохождение CI тестов: Создан Pull Request с новой моделью f_orders_stats, который был протестирован с использованием GitHub Actions для проверки работоспособности изменений и автоматической сборки проекта.
6.	Работа с файлом marts.yml: Добавлена информация о новой модели f_orders_stats в файл marts.yml, чтобы описать её роль в структуре данных проекта dbt.   
Итоги практического занятия включают в себя успешное выполнение всех задач, настройку среды разработки, создание и тестирование новой модели данных, а также улучшение процесса разработки с помощью использования инструментов управления версиями и автоматизации тестирования.





